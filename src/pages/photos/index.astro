---
import BaseLayout from "../../layouts/BaseLayout.astro";
import NavToggle from "../../components/NavToggle.astro";
---

<BaseLayout title="Photos">
  <!-- 背景图片层 -->
  <div class="parallax-bg" id="parallax-bg"></div>

  <!-- 第一屏：内容层 -->
  <section class="hero">
    <h1>Photos</h1>
  </section>

  <!-- 固定导航按钮 -->
  <NavToggle />

  <!-- 图片拼接区域 -->
  <section class="photos-container" id="photos-container"></section>
</BaseLayout>

<script>
  // 背景图片设置和视差滚动效果
  const parallaxBg = document.querySelector('.parallax-bg');
  if (parallaxBg) {
    // 根据主题模式设置背景图片
    function setBackgroundImage() {
      const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
      const backgroundImage = isDarkMode ? '/bg_photos/photo2.jpg' : '/bg_photos/photo1.jpg';
      parallaxBg.style.backgroundImage = `url('${backgroundImage}')`;
    }

    // 初始化背景
    setBackgroundImage();

    // 监听主题变化
    const observer = new MutationObserver(() => {
      setBackgroundImage();
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-theme']
    });

    // 立即设置初始transform
    parallaxBg.style.transform = 'translate3d(0, 0, 0)';
    
    // 只在滚动时更新
    window.addEventListener('scroll', () => {
      const scrolled = window.scrollY;
      parallaxBg.style.transform = `translate3d(0, -${scrolled}px, 0)`;
    }, { passive: true });
  }

  // 照片拼接逻辑
  const container = document.getElementById('photos-container');
  
  // Photos文件夹中的所有图片
  const photoFiles = [
    '1.jpg',
    '2.jpg',
    '3-1.jpg',
    '3-2.jpg',
    '4-1.jpg',
    '4-2.jpg',
    '5-1.jpg',
    '5-2.jpg',
    '6.jpg'
  ];

  // 加载所有图片的元数据
  async function loadPhotoMetadata() {
    const photoData = [];
    
    for (const file of photoFiles) {
      const img = new Image();
      img.src = `/Photos/${file}`;
      
      await new Promise((resolve) => {
        img.onload = () => {
          photoData.push({
            file,
            width: img.naturalWidth,
            height: img.naturalHeight,
            aspectRatio: img.naturalWidth / img.naturalHeight
          });
          resolve();
        };
        img.onerror = (e) => {
          console.error(`Failed to load image: /Photos/${file}`, e);
          resolve();
        };
      });
    }
    
    console.log('Loaded photos:', photoData);
    return photoData;
  }

  // 按序号分组：1单独, 2单独, (3+4)并排, (5+6)并排, ...
  function groupPhotos(photoData) {
    const groups = [];
    
    // 前两张单独
    if (photoData[0]) groups.push([photoData[0]]);
    if (photoData[1]) groups.push([photoData[1]]);
    
    // 剩余的相邻两张一组并排
    for (let i = 2; i < photoData.length; i += 2) {
      const pair = [];
      if (photoData[i]) pair.push(photoData[i]);
      if (photoData[i + 1]) pair.push(photoData[i + 1]);
      groups.push(pair);
    }
    
    console.log('Groups:', groups);
    return groups;
  }

  // 渲染照片拼接
  function renderPhotoPairs(groups) {
    const screenWidth = window.innerWidth;
    let html = '';

    for (const group of groups) {
      if (group.length === 1) {
        // 单张照片全宽
        const photo = group[0];
        const height = screenWidth / photo.aspectRatio;

        html += `
          <div class="photo-row" style="display: flex; height: ${height}px; width: 100%; overflow: hidden;">
            <img src="/Photos/${photo.file}" alt="photo" style="width: 100%; height: 100%; object-fit: cover;" />
          </div>
        `;
      } else if (group.length === 2) {
        // 两张照片并排
        const photo1 = group[0];
        const photo2 = group[1];
        
        const widthPerPhoto = screenWidth / 2;
        const height1 = widthPerPhoto / photo1.aspectRatio;
        const height2 = widthPerPhoto / photo2.aspectRatio;
        const rowHeight = Math.max(height1, height2);

        html += `
          <div class="photo-row" style="display: flex; height: ${rowHeight}px; width: 100%; overflow: hidden;">
            <img src="/Photos/${photo1.file}" alt="photo" style="width: 50%; height: 100%; object-fit: cover; flex-shrink: 0;" />
            <img src="/Photos/${photo2.file}" alt="photo" style="width: 50%; height: 100%; object-fit: cover; flex-shrink: 0;" />
          </div>
        `;
      }
    }

    console.log('Generated HTML length:', html.length);
    container.innerHTML = html;
    console.log('Container updated');
  }

  // 初始化
  loadPhotoMetadata().then((photoData) => {
    const groups = groupPhotos(photoData);
    renderPhotoPairs(groups);
  });

  // 监听窗口大小改变
  window.addEventListener('resize', () => {
    loadPhotoMetadata().then((photoData) => {
      const groups = groupPhotos(photoData);
      renderPhotoPairs(groups);
    });
  });
</script>

<style>
  .hero {
    padding: 0;
    text-align: left;
    position: relative;
    z-index: 2;
    height: 60vh;
    width: 100vw;
    margin-left: calc(-50vw + 50%);
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: flex-start;
    padding-left: 40px;
    padding-bottom: 30px;
  }

  .hero h1 {
    font-size: 48px;
    margin: 0;
    color: #ffffff;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
  }

  html[data-theme="light"] .hero h1 {
    color: #000000;
    text-shadow: 0 2px 8px rgba(255, 255, 255, 0.5);
  }

  /* 图片容器 */
  .photos-container {
    position: relative;
    z-index: 2;
    width: calc(100% + 36px);
    margin: 0 -18px;
    padding: 0;
  }

  .photo-row {
    gap: 0;
  }

  /* 第二屏纯色页面 */
  .solid-screen {
    min-height: 100vh;
    width: 100vw;
    background-color: var(--bg);
    position: relative;
    z-index: 2;
    margin-left: calc(-50vw + 50%);
  }
</style>