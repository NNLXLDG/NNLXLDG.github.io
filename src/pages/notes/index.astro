---
import BaseLayout from "../../layouts/BaseLayout.astro";
import NavToggle from "../../components/NavToggle.astro";
import { getCollection } from 'astro:content';
import fs from 'fs';
import path from 'path';

const notes = await getCollection('notes');

// 辅助函数：从文件路径提取类别和标题
function extractMetadata(note: any) {
  const id = note.id; // 例如: "software-tools/typora/index.md" 或 "mathematics/index.md"
  const parts = id.split('/');
  
  let category = parts[0]; // 第一级：分类
  let title = '';
  
  // 如果有 frontmatter 中的 category，使用它
  if (note.data.category) {
    category = note.data.category;
  }
  
  // 判断是否是二级结构（有子文件夹）
  if (parts.length === 3) {
    // 二级结构：software-tools/typora/index.md
    // title 来自第二级文件夹名（parts[1]）
    title = parts[1];
  } else if (parts.length === 2) {
    // 一级结构：mathematics/index.md
    // title 来自 category 名
    title = category;
  }
  
  // 将文件夹名转换为标题格式（横线改空格，首字母大写）
  title = title.replace(/-/g, ' ').split(' ').map((w: string) => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
  
  // 如果有 frontmatter 中的 title，使用它
  if (note.data.title) {
    title = note.data.title;
  }
  
  return { category, title };
}

// 获取文件的修改时间
function getFileModTime(id: string): number {
  try {
    const filePath = path.join(process.cwd(), 'src/content/notes', id);
    const stats = fs.statSync(filePath);
    return stats.mtimeMs;
  } catch (e) {
    return 0;
  }
}

const notesWithMeta = notes.map(note => {
  const metadata = extractMetadata(note);
  const modTime = getFileModTime(note.id);
  return {
    ...note,
    category: metadata.category,
    title: metadata.title,
    modTime: modTime
  };
});

// 按修改时间倒序（最新的在前），相同时间按 title 字母顺序排
const sortedNotes = notesWithMeta.sort((a, b) => {
  if (b.modTime !== a.modTime) {
    return b.modTime - a.modTime; // 最新的在前
  }
  return a.title.localeCompare(b.title); // 相同时间按 title 排序
});

// 获取所有分类（去重）
const uniqueCategories = Array.from(new Map(
  sortedNotes.map(note => [note.category, { title: note.category, category: note.category }])
).values());
---

<BaseLayout title="Notes">
  <!-- 背景图片层 -->
  <div class="parallax-bg" id="parallax-bg"></div>

  <!-- 第一屏：内容层 -->
  <section class="hero">
    <h1>Notes</h1>
  </section>

  <!-- 固定导航按钮 -->
  <NavToggle />

  <!-- 第二屏：纯色页面 - 专题列表 -->
  <section class="content-screen">
    <div class="notes-container">
      <!-- 科目按钮导航 -->
      <div class="category-buttons">
        <button class="category-btn active" data-category="all">All</button>
        {uniqueCategories.map((cat) => (
          <button class="category-btn" data-category={cat.category}>
            {cat.title.replace(/-/g, ' ').split(' ').map((w: string) => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}
          </button>
        ))}
      </div>

      <!-- 笔记列表 -->
      <div class="notes-list">
        {sortedNotes.map((note) => (
          <div class="note-section" data-category={note.category}>
            <h3 class="note-section-title">{note.title}</h3>
            <div class="note-content" set:html={note.body}></div>
          </div>
        ))}
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  // 背景图片设置和视差滚动效果
  const parallaxBg = document.querySelector('.parallax-bg');
  if (parallaxBg) {
    // 根据主题模式设置背景图片
    function setBackgroundImage() {
      const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
      const backgroundImage = isDarkMode ? '/bg_photos/notes2.jpg' : '/bg_photos/notes1.jpg';
      parallaxBg.style.backgroundImage = `url('${backgroundImage}')`;
      console.log('[notes] Background image set to:', backgroundImage);
    }

    // 初始化背景
    setBackgroundImage();

    // 监听主题变化
    const observer = new MutationObserver(() => {
      setBackgroundImage();
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-theme']
    });

    // 监听container的动画结束
    const container = document.querySelector('.container');
    if (container) {
      container.addEventListener('animationend', () => {
        const scrolled = window.scrollY;
        parallaxBg.style.transform = `translate3d(0, -${scrolled}px, 0)`;
      });
    }

    // 只在滚动时更新
    window.addEventListener('scroll', () => {
      const scrolled = window.scrollY;
      parallaxBg.style.transform = `translate3d(0, -${scrolled}px, 0)`;
    }, { passive: true });
  }

  // 科目过滤功能
  document.querySelectorAll('.category-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const selectedCategory = this.dataset.category;
      
      // 更新按钮状态
      document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      // 过滤笔记
      document.querySelectorAll('.note-section').forEach(section => {
        if (selectedCategory === 'all' || section.dataset.category === selectedCategory) {
          section.style.display = 'block';
        } else {
          section.style.display = 'none';
        }
      });
    });
  });
</script>

<style>
  .hero {
    padding: 0;
    text-align: left;
    position: relative;
    z-index: 2;
    height: 60vh;
    width: 100vw;
    margin-left: calc(-50vw + 50%);
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: flex-start;
    padding-left: 40px;
    padding-bottom: 30px;
  }

  .hero h1 {
    font-size: 48px;
    margin: 0;
    color: #ffffff;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    font-family: 'Garamond', 'Palatino', 'Baskerville', serif;
  }

  /* 第二屏纯色页面 */
  .content-screen {
    min-height: 100vh;
    width: 100vw;
    background-color: var(--bg);
    position: relative;
    z-index: 2;
    margin-left: calc(-50vw + 50%);
    padding: 0;
  }

  html[data-theme="light"] .content-screen {
    background-color: #ffffff;
  }

  .notes-container {
    padding: 30px 40px;
    max-width: 1200px;
    margin: 0 auto;
  }

  /* 科目按钮导航 */
  .category-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 40px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .category-btn {
    padding: 8px 16px;
    border: 1px solid var(--text);
    background-color: transparent;
    color: var(--text);
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .category-btn:hover {
    background-color: var(--text);
    color: var(--bg);
  }

  .category-btn.active {
    background-color: var(--text);
    color: var(--bg);
  }

  /* 笔记列表 */
  .notes-list {
    display: flex;
    flex-direction: column;
    gap: 32px;
  }

  .note-section {
    transition: all 0.3s ease;
  }

  .note-section-title {
    font-size: 24px;
    font-weight: 600;
    margin: 0 0 16px 0;
    color: var(--text);
  }

  .note-items {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding-left: 16px;
  }

  .note-item {
    font-size: 15px;
    color: var(--text);
    opacity: 0.8;
    padding-left: 12px;
    border-left: 3px solid var(--text);
  }

  /* Markdown content styles */
  .note-content {
    font-size: 15px;
    color: var(--text);
    line-height: 1.8;
  }

  .note-content p {
    margin: 12px 0;
    color: var(--text);
  }

  .note-content h1,
  .note-content h2,
  .note-content h3,
  .note-content h4,
  .note-content h5,
  .note-content h6 {
    margin: 20px 0 12px 0;
    color: var(--text);
    font-weight: 600;
  }

  .note-content h1 {
    font-size: 28px;
  }

  .note-content h2 {
    font-size: 24px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 8px;
  }

  .note-content h3 {
    font-size: 20px;
  }

  .note-content h4 {
    font-size: 17px;
  }

  .note-content ul,
  .note-content ol {
    margin: 12px 0;
    padding-left: 32px;
  }

  .note-content li {
    margin: 8px 0;
    color: var(--text);
  }

  .note-content li p {
    margin: 4px 0;
  }

  .note-content code {
    background-color: var(--card-bg);
    color: var(--text);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Monaco', 'Courier New', monospace;
    font-size: 14px;
  }

  .note-content pre {
    background-color: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    overflow-x: auto;
    margin: 16px 0;
    line-height: 1.5;
  }

  .note-content pre code {
    background-color: transparent;
    padding: 0;
    color: var(--text);
    font-family: 'Monaco', 'Courier New', monospace;
    font-size: 14px;
  }

  .note-content blockquote {
    border-left: 4px solid var(--accent);
    padding-left: 16px;
    margin: 16px 0;
    color: var(--muted);
    font-style: italic;
  }

  .note-content img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 16px 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .note-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 16px 0;
  }

  .note-content table th,
  .note-content table td {
    padding: 12px;
    text-align: left;
    border: 1px solid var(--border);
  }

  .note-content table th {
    background-color: var(--card-bg);
    font-weight: 600;
  }

  .note-content a {
    color: var(--accent);
    text-decoration: none;
    border-bottom: 1px solid var(--accent);
    transition: opacity 0.3s ease;
  }

  .note-content a:hover {
    opacity: 0.7;
  }

  .note-content hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 24px 0;
  }

  @media (max-width: 640px) {
    .hero h1 {
      font-size: 32px;
    }

    .notes-container {
      padding: 40px 20px;
    }

    .category-buttons {
      gap: 8px;
      margin-bottom: 30px;
    }

    .category-btn {
      padding: 6px 12px;
      font-size: 13px;
    }

    .notes-list {
      gap: 24px;
    }

    .note-section-title {
      font-size: 20px;
    }

    .note-item {
      font-size: 14px;
    }
  }
</style>