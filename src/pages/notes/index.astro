---
import BaseLayout from "../../layouts/BaseLayout.astro";
import NavToggle from "../../components/NavToggle.astro";
import { marked } from 'marked';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const notesDir = path.join(__dirname, '../../..', 'public', 'content');

// 辅助函数：规范化分类名
function normalizeCategory(category: string): string {
  return category.toLowerCase().trim().replace(/\s+/g, '-');
}

// 辅助函数：格式化显示的分类名
function formatCategoryDisplay(category: string): string {
  return category
    .replace(/-/g, ' ')
    .split(' ')
    .map((w: string) => w.charAt(0).toUpperCase() + w.slice(1))
    .join(' ');
}

// 从文件系统读取所有笔记
function readNotesFromFS() {
  const notes: any[] = [];
  
  // 如果目录不存在，直接返回空数组
  if (!fs.existsSync(notesDir)) {
    return notes;
  }
  
  const walkDir = (dir: string, relative: string = '') => {
    try {
      const files = fs.readdirSync(dir);
      files.forEach(file => {
        const fullPath = path.join(dir, file);
        const relPath = relative ? `${relative}/${file}` : file;
        
        if (fs.statSync(fullPath).isDirectory()) {
          if (file !== 'assets') {
            walkDir(fullPath, relPath);
          }
        } else if (file.endsWith('.md')) {
          const body = fs.readFileSync(fullPath, 'utf-8');
          notes.push({
            id: relPath,
            body: body,
            filePath: fullPath
          });
        }
      });
    } catch (error) {
      console.error(`Error reading directory ${dir}:`, error);
    }
  };
  
  walkDir(notesDir);
  return notes;
}

const notes = readNotesFromFS();

// 辅助函数：获取文件修改时间
function getFileModTime(filePath: string): number {
  try {
    return fs.statSync(filePath).mtimeMs || 0;
  } catch {
    return 0;
  }
}

// 辅助函数：从笔记 ID 提取元数据
function extractMetadata(note: any) {
  const id = note.id;
  const parts = id.split('/').filter((p: string) => p);
  
  const category = parts[0] || '';
  let title = '';
  
  if (parts.length >= 3) {
    // 三级结构：category/subcategory/filename.md
    title = getTitleFromFilename(parts[parts.length - 1]);
  } else if (parts.length === 2) {
    // 二级：category/filename.md
    const filename = parts[1];
    if (filename === 'index.md') {
      title = category;
    } else {
      title = getTitleFromFilename(filename);
    }
  } else if (parts.length === 1) {
    title = getTitleFromFilename(parts[0]);
  }
  
  title = title.replace(/-/g, ' ').split(' ').map((w: string) => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
  const normalizedCategory = normalizeCategory(category);
  
  return { category: normalizedCategory, title };
}

// 从文件名提取标题
function getTitleFromFilename(filename: string): string {
  return filename.replace(/\.md$/, '');
}

// 处理并编译所有笔记内容
const notesWithMeta = notes.map(note => {
  const metadata = extractMetadata(note);
  const modTime = fs.statSync(note.filePath).mtimeMs || 0;
  
  // 使用 marked 将 markdown 编译为 HTML
  let htmlContent = marked(note.body);
  
  // 处理图片路径：将占位符转换为正确的访问路径
  const noteDir = note.id.substring(0, note.id.lastIndexOf('/'));
  
  // 替换 __IMGPLACEHOLDER__filename__IMGPLACEHOLDER__ 为正确的路径
  htmlContent = htmlContent.replace(/__IMGPLACEHOLDER__(.+?)__IMGPLACEHOLDER__/g, 
    (match, imgName) => {
      // 解码 URL 编码的文件名
      let decodedName = decodeURIComponent(imgName);
      // 移除任何前缀的 assets/ 或其他路径
      decodedName = decodedName.split('/').pop();
      return `/content/${noteDir}/assets/${decodedName}`;
    }
  );
  
  // 处理 markdown 直接生成的相对路径图片引用
  // 匹配 src="xxxx" 或 src='xxxx' 中不包含 / 的相对路径（既不是 http(s):// 也不是 / 开头）
  htmlContent = htmlContent.replace(/src=["'](?!(?:https?:|\/))([^"']+)["']/g, 
    (match, imgName) => {
      // 仅处理看起来像文件名的情况（包含扩展名）
      if (/\.\w+$/.test(imgName)) {
        // 解码 URL 编码的文件名
        let decodedName = decodeURIComponent(imgName);
        // 移除任何前缀的 assets/
        decodedName = decodedName.split('/').pop();
        // 返回正确的路径 - 首先尝试 assets 文件夹，否则使用同级目录
        return `src="/content/${noteDir}/${decodedName}"`;
      }
      return match;
    }
  );
  
  return {
    ...note,
    category: metadata.category,
    title: metadata.title,
    modTime: modTime,
    htmlContent: htmlContent
  };
});

// 按修改时间倒序（最新的在前），相同时间按 title 字母顺序排
const sortedNotes = notesWithMeta.sort((a, b) => {
  if (b.modTime !== a.modTime) {
    return b.modTime - a.modTime; // 最新的在前
  }
  return a.title.localeCompare(b.title); // 相同时间按 title 排序
});

// 获取所有分类（去重 + 排序）
const uniqueCategories = Array.from(new Map(
  sortedNotes.map(note => [
    note.category,
    { 
      key: note.category,
      title: formatCategoryDisplay(note.category),
      category: note.category
    }
  ])
).values())
.sort((a, b) => a.title.localeCompare(b.title));

// 按分类分组笔记
const notesByCategory: Record<string, typeof sortedNotes> = {};
sortedNotes.forEach(note => {
  if (!notesByCategory[note.category]) {
    notesByCategory[note.category] = [];
  }
  notesByCategory[note.category].push(note);
});
---

<BaseLayout title="Notes">
  <!-- 背景图片层 -->
  <div class="parallax-bg" id="parallax-bg"></div>

  <!-- 第一屏：内容层 -->
  <section class="hero">
    <h1>Notes</h1>
  </section>

  <!-- 固定导航按钮 -->
  <NavToggle />

  <!-- 第二屏：纯色页面 - 专题列表 -->
  <section class="content-screen">
    <div class="notes-container">
      <!-- 科目按钮导航 -->
      <div class="category-buttons">
        <button class="category-btn active" data-category="all">All</button>
        {uniqueCategories.map((cat) => (
          <button class="category-btn" data-category={cat.key}>
            {cat.title}
          </button>
        ))}
      </div>

      <!-- 笔记列表 -->
      <div class="notes-list">
        {uniqueCategories.map((cat) => (
          <div class="notes-category-group" data-category={cat.key}>
            {notesByCategory[cat.key]?.map((note) => (
              <div class="note-item-clickable" data-note-id={note.id}>
                <h3 class="note-title">{note.title}</h3>
              </div>
            ))}
          </div>
        ))}
      </div>

      <!-- 笔记内容展示 -->
      <div class="note-detail-view" id="note-detail-view">
        <button class="note-detail-close" id="note-detail-close">✕</button>
        <div class="note-detail-content"></div>
      </div>

      <!-- 隐藏的笔记内容容器 -->
      <div id="note-html-storage" style="display: none;">
        {sortedNotes.map((note) => (
          <div data-note-id={note.id} data-note-title={note.title}>
            <div set:html={note.htmlContent} />
          </div>
        ))}
      </div>
    </div>
  </section>
</BaseLayout>

<script define:vars={{ notesByCategory: JSON.stringify(notesByCategory), sortedNotes: JSON.stringify(sortedNotes.map(n => ({ id: n.id, category: n.category, title: n.title }))) }}>
  // 背景图片设置和视差滚动效果
  const parallaxBg = document.querySelector('.parallax-bg');
  if (parallaxBg) {
    // 根据主题模式设置背景图片
    function setBackgroundImage() {
      const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
      const backgroundImage = isDarkMode ? '/bg_photos/notes2.jpg' : '/bg_photos/notes1.jpg';
      parallaxBg.style.backgroundImage = `url('${backgroundImage}')`;
    }

    // 初始化背景
    setBackgroundImage();

    // 监听主题变化
    const observer = new MutationObserver(() => {
      setBackgroundImage();
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-theme']
    });

    // 监听container的动画结束
    const container = document.querySelector('.container');
    if (container) {
      container.addEventListener('animationend', () => {
        const scrolled = window.scrollY;
        parallaxBg.style.transform = `translate3d(0, -${scrolled}px, 0)`;
      });
    }

    // 只在滚动时更新
    window.addEventListener('scroll', () => {
      const scrolled = window.scrollY;
      parallaxBg.style.transform = `translate3d(0, -${scrolled}px, 0)`;
    }, { passive: true });
  }

  // 科目过滤功能
  document.querySelectorAll('.category-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const selectedCategory = this.dataset.category;
      
      // 更新按钮状态
      document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      // 过滤笔记
      document.querySelectorAll('.notes-category-group').forEach(group => {
        if (selectedCategory === 'all' || group.dataset.category === selectedCategory) {
          group.style.display = 'block';
        } else {
          group.style.display = 'none';
        }
      });
    });
  });

  // 笔记点击展开功能
  const noteDetailView = document.getElementById('note-detail-view');
  const noteDetailClose = document.getElementById('note-detail-close');
  const noteDetailContent = noteDetailView.querySelector('.note-detail-content');
  const noteHtmlStorage = document.getElementById('note-html-storage');
  
  document.querySelectorAll('.note-item-clickable').forEach(item => {
    item.addEventListener('click', function() {
      const noteId = this.dataset.noteId;
      const noteContainer = noteHtmlStorage.querySelector(`[data-note-id="${noteId}"]`);
      
      if (noteContainer) {
        const noteTitle = noteContainer.getAttribute('data-note-title');
        const noteHtml = noteContainer.innerHTML;
        noteDetailContent.innerHTML = `<h2>${noteTitle}</h2>${noteHtml}`;
        noteDetailView.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
    });
  });
  
  // 关闭笔记详情
  noteDetailClose.addEventListener('click', () => {
    noteDetailView.classList.remove('active');
    document.body.style.overflow = 'auto';
  });
  
  // 点击背景关闭
  noteDetailView.addEventListener('click', (e) => {
    if (e.target === noteDetailView) {
      noteDetailView.classList.remove('active');
      document.body.style.overflow = 'auto';
    }
  });
</script>

<style>
  .hero {
    padding: 0;
    text-align: left;
    position: relative;
    z-index: 2;
    height: 60vh;
    width: 100vw;
    margin-left: calc(-50vw + 50%);
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: flex-start;
    padding-left: 40px;
    padding-bottom: 30px;
  }

  .hero h1 {
    font-size: 48px;
    margin: 0;
    color: #ffffff;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    font-family: 'Garamond', 'Palatino', 'Baskerville', serif;
  }

  /* 第二屏纯色页面 */
  .content-screen {
    min-height: 100vh;
    width: 100vw;
    background-color: var(--bg);
    position: relative;
    z-index: 2;
    margin-left: calc(-50vw + 50%);
    padding: 0;
  }

  html[data-theme="light"] .content-screen {
    background-color: #ffffff;
  }

  .notes-container {
    padding: 30px 40px;
    max-width: 1200px;
    margin: 0 auto;
  }

  /* 科目按钮导航 */
  .category-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 40px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .category-btn {
    padding: 8px 16px;
    border: 1px solid var(--text);
    background-color: transparent;
    color: var(--text);
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .category-btn:hover {
    background-color: var(--text);
    color: var(--bg);
  }

  .category-btn.active {
    background-color: var(--text);
    color: var(--bg);
  }

  /* 笔记列表 */
  .notes-list {
    display: flex;
    flex-direction: column;
    gap: 32px;
  }

  .note-section {
    transition: all 0.3s ease;
  }

  .note-section-title {
    font-size: 24px;
    font-weight: 600;
    margin: 0 0 16px 0;
    color: var(--text);
  }

  .note-items {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding-left: 16px;
  }

  .note-item {
    font-size: 15px;
    color: var(--text);
    opacity: 0.8;
    padding-left: 12px;
    border-left: 3px solid var(--text);
  }

  /* Markdown content styles */
  .note-content {
    font-size: 15px;
    color: var(--text);
    line-height: 1.8;
  }

  .note-content p {
    margin: 12px 0;
    color: var(--text);
  }

  .note-content h1,
  .note-content h2,
  .note-content h3,
  .note-content h4,
  .note-content h5,
  .note-content h6 {
    margin: 20px 0 12px 0;
    color: var(--text);
    font-weight: 600;
  }

  .note-content h1 {
    font-size: 28px;
  }

  .note-content h2 {
    font-size: 24px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 8px;
  }

  .note-content h3 {
    font-size: 20px;
  }

  .note-content h4 {
    font-size: 17px;
  }

  .note-content ul,
  .note-content ol {
    margin: 12px 0;
    padding-left: 32px;
  }

  .note-content li {
    margin: 8px 0;
    color: var(--text);
  }

  .note-content li p {
    margin: 4px 0;
  }

  .note-content code {
    background-color: var(--card-bg);
    color: var(--text);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Monaco', 'Courier New', monospace;
    font-size: 14px;
  }

  .note-content pre {
    background-color: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    overflow-x: auto;
    margin: 16px 0;
    line-height: 1.5;
  }

  .note-content pre code {
    background-color: transparent;
    padding: 0;
    color: var(--text);
    font-family: 'Monaco', 'Courier New', monospace;
    font-size: 14px;
  }

  .note-content blockquote {
    border-left: 4px solid var(--accent);
    padding-left: 16px;
    margin: 16px 0;
    color: var(--muted);
    font-style: italic;
  }

  .note-content img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 16px 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .note-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 16px 0;
  }

  .note-content table th,
  .note-content table td {
    padding: 12px;
    text-align: left;
    border: 1px solid var(--border);
  }

  .note-content table th {
    background-color: var(--card-bg);
    font-weight: 600;
  }

  .note-content a {
    color: var(--accent);
    text-decoration: none;
    border-bottom: 1px solid var(--accent);
    transition: opacity 0.3s ease;
  }

  .note-content a:hover {
    opacity: 0.7;
  }

  .note-content hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 24px 0;
  }

  @media (max-width: 640px) {
    .hero h1 {
      font-size: 32px;
    }

    .notes-container {
      padding: 40px 20px;
    }

    .category-buttons {
      gap: 8px;
      margin-bottom: 30px;
    }

    .category-btn {
      padding: 6px 12px;
      font-size: 13px;
    }

    .notes-list {
      gap: 24px;
    }

    .note-section-title {
      font-size: 20px;
    }

    .note-item {
      font-size: 14px;
    }
  }
</style>